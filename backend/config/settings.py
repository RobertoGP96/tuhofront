"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 5.0.2.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.0/ref/settings/
"""

import os
from pathlib import Path
from dotenv import load_dotenv

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Cargar variables de entorno desde archivo .env
env_path = BASE_DIR / '.env'
if env_path.exists():
    load_dotenv(env_path)
else:
    # Si no existe .env, intentar cargar desde la raÃ­z del proyecto backend
    load_dotenv(BASE_DIR.parent / '.env')

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
# Obtener SECRET_KEY de variables de entorno, con fallback para desarrollo
SECRET_KEY = os.getenv(
    'SECRET_KEY',
    'django-insecure-@e2&yg!lk#5aj&yvs-&%%-%@=t90rvn)+y@u*6bdebh7a^et))'  # Fallback solo para desarrollo
)

# SECURITY WARNING: don't run with debug turned on in production!
# DEBUG debe ser False en producciÃ³n
DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'

# Dominio del sitio
DOMAIN = os.getenv('DOMAIN', '127.0.0.1:8000')

# Hosts permitidos - separados por comas en .env
ALLOWED_HOSTS_STR = os.getenv('ALLOWED_HOSTS', '*')
ALLOWED_HOSTS = [host.strip() for host in ALLOWED_HOSTS_STR.split(',') if host.strip()]

import sys

# Agregar la carpeta 'apps' al PYTHONPATH
sys.path.append(os.path.join(BASE_DIR, 'apps'))

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    'drf_spectacular',
    'platform',
    'usuarios',
    'atention',
    'notifications',
    'secretary_doc',
    'internal',
    'labs',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

# JWT Settings
from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(
        minutes=int(os.getenv('JWT_ACCESS_TOKEN_LIFETIME', '60'))
    ),
    'REFRESH_TOKEN_LIFETIME': timedelta(
        days=int(os.getenv('JWT_REFRESH_TOKEN_LIFETIME', '7'))
    ),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': False,

    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'VERIFYING_KEY': None,
    'AUDIENCE': None,
    'ISSUER': None,

    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
    'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',

    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
    'TOKEN_TYPE_CLAIM': 'token_type',
}

# CORS Settings - Configurable desde variables de entorno
CORS_ALLOWED_ORIGINS_STR = os.getenv(
    'CORS_ALLOWED_ORIGINS',
    'http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173'
)
CORS_ALLOWED_ORIGINS = [
    origin.strip() for origin in CORS_ALLOWED_ORIGINS_STR.split(',') if origin.strip()
]

CORS_ALLOW_CREDENTIALS = os.getenv('CORS_ALLOW_CREDENTIALS', 'True').lower() == 'true'
CORS_ALLOW_ALL_ORIGINS = DEBUG  # Solo en desarrollo

# Spectacular Settings (API Documentation)
SPECTACULAR_SETTINGS = {
    'TITLE': 'TUho API - Sistema Integral Universitario',
    'DESCRIPTION': '''
    ## ğŸ“ API para la aplicaciÃ³n TUho - Sistema Integral de GestiÃ³n Universitaria
    
    ### ğŸ“‹ Funcionalidades Principales
    
    Esta API proporciona endpoints organizados para:
    
    #### ğŸ” **AutenticaciÃ³n y Seguridad**
    - Registro y activaciÃ³n de cuentas
    - Login/Logout con JWT
    - GestiÃ³n de tokens y sesiones
    - RecuperaciÃ³n de contraseÃ±as
    
    #### ğŸ‘¥ **GestiÃ³n de Usuarios**
    - AdministraciÃ³n de usuarios del sistema
    - Perfiles y informaciÃ³n personal
    - Roles y permisos
    
    #### ğŸ“¢ **ComunicaciÃ³n**
    - Sistema de notificaciones internas
    - PublicaciÃ³n de noticias y anuncios
    - ConfiguraciÃ³n de correos electrÃ³nicos
    
    #### ğŸ›ï¸ **Servicios Ciudadanos**
    - AtenciÃ³n a la poblaciÃ³n
    - Solicitudes y consultas
    - Seguimiento de trÃ¡mites
    
    #### ğŸ“ **Servicios AcadÃ©micos**
    - TrÃ¡mites de secretarÃ­a docente
    - Certificados y documentos
    - GestiÃ³n estudiantil
    
    #### ğŸ¢ **Procedimientos Internos**
    - GestiÃ³n de huÃ©spedes
    - Servicios de alimentaciÃ³n
    - Transporte institucional
    - Mantenimiento y reparaciones
    
    ---
    
    ### ğŸš€ **GuÃ­a de Inicio RÃ¡pido**
    
    #### 1ï¸âƒ£ **AutenticaciÃ³n**
    ```bash
    # Iniciar sesiÃ³n
    POST /api/v1/auth/login/
    {
        "username": "tu_usuario",
        "password": "tu_contraseÃ±a"
    }
    ```
    
    #### 2ï¸âƒ£ **Usar Token**
    ```
    Authorization: Bearer <tu_token_jwt>
    ```
    
    #### 3ï¸âƒ£ **Probar Endpoints**
    Usa el botÃ³n "Authorize" arriba para configurar tu token y probar los endpoints.
    
    ---
    
    ### ğŸ“Š **CÃ³digos de Respuesta**
    - `200` âœ… Ã‰xito
    - `201` âœ… Creado
    - `400` âŒ Error en datos
    - `401` ğŸ”’ No autorizado
    - `403` ğŸš« Sin permisos
    - `404` ğŸ” No encontrado
    - `500` ğŸ’¥ Error servidor
    
    ### ğŸ“– **DocumentaciÃ³n Adicional**
    - **ReDoc**: [http://127.0.0.1:8000/api/redoc/](http://127.0.0.1:8000/api/redoc/) - Vista completa
    - **Schema JSON**: [http://127.0.0.1:8000/api/schema/](http://127.0.0.1:8000/api/schema/) - Esquema OpenAPI
    ''',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
    'CONTACT': {
        'name': 'Equipo de Desarrollo TUho',
        'email': 'secretariadocenteuho@gmail.com',
        'url': 'https://www.uho.edu.cu'
    },
    'LICENSE': {
        'name': 'Uso Interno - Universidad de HolguÃ­n',
        'url': 'https://www.uho.edu.cu'
    },
    'EXTERNAL_DOCS': {
        'description': 'DocumentaciÃ³n completa en ReDoc',
        'url': 'http://127.0.0.1:8000/api/redoc/'
    },
    'SERVERS': [
        {
            'url': 'http://127.0.0.1:8000',
            'description': 'ğŸ› ï¸ Servidor de Desarrollo Local'
        },
        {
            'url': 'https://api.tuho.uho.edu.cu',
            'description': 'ğŸŒ Servidor de ProducciÃ³n (Futuro)'
        }
    ],
    'TAGS': [
        {
            'name': 'ğŸ” AutenticaciÃ³n',
            'description': '''
            **GestiÃ³n de acceso y seguridad**
            
            Endpoints para:
            - ğŸšª Login/Logout
            - ğŸ“ Registro de usuarios
            - ğŸ”„ RenovaciÃ³n de tokens
            - âœ… ValidaciÃ³n de cuentas
            - ğŸ”‘ RecuperaciÃ³n de contraseÃ±as
            - ğŸ‘¤ InformaciÃ³n de perfil
            '''
        },
        {
            'name': 'ğŸ‘¥ Usuarios',
            'description': '''
            **AdministraciÃ³n de usuarios del sistema**
            
            Funcionalidades:
            - ğŸ“‹ Listado y bÃºsqueda de usuarios
            - â• CreaciÃ³n de nuevos usuarios
            - âœï¸ EdiciÃ³n de informaciÃ³n personal
            - ğŸ—‘ï¸ EliminaciÃ³n de cuentas
            - ğŸ›¡ï¸ GestiÃ³n de roles y permisos
            
            **âš ï¸ Acceso restringido a administradores**
            '''
        },
        {
            'name': 'ğŸ”” Notificaciones',
            'description': '''
            **Sistema de notificaciones internas**
            
            CaracterÃ­sticas:
            - ğŸ“¬ EnvÃ­o de notificaciones personalizadas
            - ğŸ“– Marcado de leÃ­do/no leÃ­do
            - ğŸ¯ Notificaciones dirigidas
            - â° Historial temporal
            - ğŸ” Filtros y bÃºsqueda
            '''
        },
        {
            'name': 'ğŸ›ï¸ AtenciÃ³n a la PoblaciÃ³n',
            'description': '''
            **Servicios de atenciÃ³n ciudadana**
            
            Incluye:
            - ğŸ“ Solicitudes ciudadanas
            - ğŸ“‹ Seguimiento de casos
            - ğŸ’¬ Respuestas oficiales
            - ğŸ“Š Estados de tramitaciÃ³n
            - ğŸ—‚ï¸ Historial de solicitudes
            '''
        },
        {
            'name': 'ğŸ“° Plataforma - Noticias',
            'description': '''
            **GestiÃ³n de contenido informativo**
            
            Funciones:
            - ğŸ“° PublicaciÃ³n de noticias
            - ğŸ“… ProgramaciÃ³n de contenido
            - ğŸ–¼ï¸ GestiÃ³n multimedia
            - ğŸ‘ï¸ Control de visibilidad
            - ğŸ“ˆ MÃ©tricas de visualizaciÃ³n
            '''
        },
        {
            'name': 'âœ‰ï¸ Plataforma - Email',
            'description': '''
            **ConfiguraciÃ³n del sistema de correos**
            
            AdministraciÃ³n de:
            - âš™ï¸ ConfiguraciÃ³n SMTP
            - ğŸ“§ Plantillas de email
            - ğŸ” Credenciales de servidor
            - ğŸ“Š Logs de envÃ­o
            
            **ğŸ”’ Solo administradores**
            '''
        },
        {
            'name': 'ğŸ“Š Plataforma - Estados',
            'description': '''
            **GestiÃ³n de estados de trÃ¡mites**
            
            Control de:
            - ğŸ·ï¸ DefiniciÃ³n de estados
            - ğŸ”„ Flujos de trabajo
            - ğŸ“ˆ Seguimiento de progreso
            - ğŸ¨ PersonalizaciÃ³n visual
            '''
        },
        {
            'name': 'ğŸ“ SecretarÃ­a Docente',
            'description': '''
            **Servicios acadÃ©micos y estudiantiles**
            
            TrÃ¡mites disponibles:
            - ğŸ“œ Certificados acadÃ©micos
            - ğŸ“‹ Constancias de estudio
            - ğŸ¯ Solicitudes especiales
            - ğŸ“Š Historial acadÃ©mico
            - âš¡ TrÃ¡mites urgentes
            
            **ğŸ‘¨â€ğŸ“ Estudiantes ven solo los suyos**
            '''
        },
        {
            'name': 'ğŸ¨ Procedimientos - HuÃ©spedes',
            'description': '''
            **GestiÃ³n de visitantes y huÃ©spedes**
            
            Servicios:
            - ğŸ“ Registro de huÃ©spedes
            - ğŸ  AsignaciÃ³n de alojamiento
            - ğŸ“… Control de estadÃ­as
            - ğŸ’° GestiÃ³n de pagos
            - ğŸ“Š Reportes de ocupaciÃ³n
            '''
        },
        {
            'name': 'ğŸ½ï¸ Procedimientos - AlimentaciÃ³n',
            'description': '''
            **Servicios de comedor y alimentaciÃ³n**
            
            GestiÃ³n de:
            - ğŸ“… DÃ­as de alimentaciÃ³n
            - ğŸ½ï¸ MenÃºs y dietas
            - ğŸ‘¥ Solicitudes de comida
            - ğŸ’³ Pagos y descuentos
            - ğŸ“ˆ EstadÃ­sticas de consumo
            '''
        },
        {
            'name': 'ğŸ¢ Procedimientos - Estructura',
            'description': '''
            **OrganizaciÃ³n interna institucional**
            
            AdministraciÃ³n de:
            - ğŸ›ï¸ Departamentos
            - ğŸ“ Ãreas funcionales
            - ğŸ‘¥ AsignaciÃ³n de personal
            - ğŸ“Š JerarquÃ­as organizacionales
            - ğŸ“‹ Responsabilidades
            '''
        },
        {
            'name': 'ğŸš— Procedimientos - Transporte',
            'description': '''
            **GestiÃ³n de transporte institucional**
            
            Servicios:
            - ğŸšŒ Solicitudes de transporte
            - ğŸ“… ProgramaciÃ³n de viajes
            - ğŸ›£ï¸ Rutas y destinos
            - ğŸ‘¨â€âœˆï¸ AsignaciÃ³n de conductores
            - â›½ Control de combustible
            '''
        },
        {
            'name': 'ğŸ”§ Procedimientos - Mantenimiento',
            'description': '''
            **Sistema de mantenimiento y reparaciones**
            
            Funcionalidades:
            - ğŸ”¨ Solicitudes de reparaciÃ³n
            - âš¡ Niveles de prioridad
            - ğŸ‘· AsignaciÃ³n de tÃ©cnicos
            - ğŸ“Š Seguimiento de trabajos
            - ğŸ’° Control de costos
            '''
        },
        {
            'name': 'ğŸ—‚ï¸ Estructura - Ãreas',
            'description': '''
            **GestiÃ³n de Ã¡reas bÃ¡sicas del sistema**
            
            AdministraciÃ³n de:
            - ğŸ“ DefiniciÃ³n de Ã¡reas
            - ğŸ“ Descripciones funcionales
            - ğŸ”— Relaciones jerÃ¡rquicas
            
            **ğŸ”’ Solo administradores**
            '''
        }
    ],
    'COMPONENT_SPLIT_REQUEST': True,
    'SORT_OPERATIONS': False,
    'SWAGGER_UI_SETTINGS': {
        'deepLinking': True,
        'persistAuthorization': True,
        'displayOperationId': False,
        'defaultModelsExpandDepth': 2,
        'defaultModelExpandDepth': 2,
        'defaultModelRendering': 'model',
        'displayRequestDuration': True,
        'docExpansion': 'none',
        'filter': True,
        'showExtensions': True,
        'showCommonExtensions': True,
        'tryItOutEnabled': True
    },
    'REDOC_UI_SETTINGS': {
        'nativeScrollbars': False,
        'theme': {
            'colors': {
                'primary': {
                    'main': '#1976d2'
                }
            },
            'typography': {
                'fontSize': '14px',
                'lineHeight': '1.5em',
                'code': {
                    'fontSize': '13px'
                },
                'headings': {
                    'fontFamily': 'Montserrat, sans-serif'
                }
            }
        }
    }
}

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': ["templates","templates/"],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'notificaciones.context.notificacionesContext',
                'config.context.groups_processor'
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Base de Datos postgreSQL
'''DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'TUho',
        'USER': 'postgres',
        'PASSWORD': 'postgres',
        'HOST':'127.0.0.1',
        'DATABASE_PORT':'5432',
    }
}'''


# Password validation
# https://docs.djangoproject.com/en/5.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.0/topics/i18n/

LANGUAGE_CODE = 'es-es'

TIME_ZONE = 'Cuba'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.0/howto/static-files/

STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / "static"]
STATIC_ROOT = BASE_DIR / "staticfiles"  # Directorio donde se recopilan los archivos estÃ¡ticos
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')


# Default primary key field type
# https://docs.djangoproject.com/en/5.0/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

LOGIN_URL = 'Login'

AUTH_USER_MODEL = 'usuarios.Usuario'

# Email Config - Usar variables de entorno para credenciales sensibles
EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', 'django.core.mail.backends.smtp.EmailBackend')
EMAIL_HOST = os.getenv('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', 'secretariadocenteuho@gmail.com')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', 'wxeq mujn uogo e lv v')
EMAIL_PORT = int(os.getenv('EMAIL_PORT', '465'))
EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'False').lower() == 'true'
EMAIL_USE_SSL = os.getenv('EMAIL_USE_SSL', 'True').lower() == 'true'
DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', EMAIL_HOST_USER)

ALLOWED_REDIRECT_URLS = ['mailto://']

